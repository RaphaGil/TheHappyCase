{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/raphaeladoamaralgil/Desktop/HappyCase/TheHappy/TheHappyCase/src/app/api/create-payment-intent/route.js"],"sourcesContent":["import Stripe from 'stripe';\n\n/**\n * Next.js API Route for Creating Payment Intent\n * \n * Creates a Stripe payment intent for checkout.\n * Requires STRIPE_SECRET_KEY in environment variables.\n */\n\n// Helper function to get Stripe instance with validation\nconst getStripeInstance = () => {\n  const secretKey = process.env.STRIPE_SECRET_KEY;\n  \n  // Validate key exists\n  if (!secretKey) {\n    throw new Error('STRIPE_SECRET_KEY environment variable is not set. Please configure it in environment variables.');\n  }\n  \n  // Validate key format (should start with sk_test_ or sk_live_)\n  if (!secretKey.startsWith('sk_test_') && !secretKey.startsWith('sk_live_')) {\n    throw new Error(\"Invalid STRIPE_SECRET_KEY format. Key must start with 'sk_test_' (test mode) or 'sk_live_' (live mode).\");\n  }\n  \n  // Remove any whitespace that might have been accidentally added\n  const cleanKey = secretKey.trim();\n  \n  try {\n    return new Stripe(cleanKey);\n  } catch (error) {\n    throw new Error(`Failed to initialize Stripe: ${error.message}`);\n  }\n};\n\n// Helper to send JSON response\nconst sendResponse = (statusCode, body, headers = {}) => {\n  return new Response(JSON.stringify(body), {\n    status: statusCode,\n    headers: {\n      'Content-Type': 'application/json',\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Headers': 'Content-Type',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      ...headers,\n    },\n  });\n};\n\nexport async function POST(request) {\n  // Handle CORS preflight\n  if (request.method === 'OPTIONS') {\n    return sendResponse(200, {});\n  }\n\n  try {\n    // Initialize Stripe with validation\n    const stripe = getStripeInstance();\n    const body = await request.json();\n    const { amount, currency, items, customerInfo } = body || {};\n\n    // Validate required fields\n    if (!amount || amount <= 0) {\n      return sendResponse(400, {\n        error: 'Amount is required and must be greater than 0',\n      });\n    }\n\n    // Use currency from request or default to GBP\n    const resolvedCurrency = (currency || 'gbp').toLowerCase();\n    const roundedAmount = Math.round(amount);\n\n    // Stripe minimum amounts by currency (in smallest currency unit)\n    const minimumAmounts = {\n      'gbp': 30,      // 30 pence = £0.30\n      'eur': 50,      // 50 cents = €0.50\n    };\n\n    const minimumAmount = minimumAmounts[resolvedCurrency] || 30;\n\n    if (roundedAmount < minimumAmount) {\n      const currencySymbols = {\n        'gbp': '£',\n        'eur': '€',\n      };\n      const symbol = currencySymbols[resolvedCurrency] || resolvedCurrency.toUpperCase();\n      const minDisplay = (minimumAmount / 100).toFixed(2);\n      const currentDisplay = (roundedAmount / 100).toFixed(2);\n\n      return sendResponse(400, {\n        error: `Amount is too small. Minimum amount is ${symbol}${minDisplay}. Your amount is ${symbol}${currentDisplay}.`,\n      });\n    }\n\n    // Build payment intent parameters\n    const paymentIntentParams = {\n      amount: roundedAmount,\n      currency: resolvedCurrency,\n      automatic_payment_methods: { enabled: true },\n    };\n\n    // Add metadata if items or customerInfo are provided\n    // Note: Stripe metadata has a 500 character limit per value\n    // We need to exclude large image data URLs and summarize items\n    if (items || customerInfo) {\n      paymentIntentParams.metadata = {};\n      \n      if (items && Array.isArray(items)) {\n        // Create a summary of items without large image data\n        const itemsSummary = items.map(item => ({\n          id: item.id,\n          name: item.name || item.caseName,\n          type: item.type || item.caseType,\n          quantity: item.quantity || 1,\n          price: item.price || item.basePrice || item.totalPrice,\n          // Exclude large image data URLs (designImage, caseImage, image)\n          // Only include a flag indicating if custom design exists\n          hasCustomDesign: !!item.customDesign,\n          hasDesignImage: !!item.designImage,\n          // Include color/category info if available\n          color: item.color,\n          category: item.category,\n        }));\n        \n        // Stringify the summary (should be much smaller)\n        const itemsJson = JSON.stringify(itemsSummary);\n        \n        // If still too large, truncate or use a more minimal summary\n        if (itemsJson.length > 450) {\n          // Use an even more minimal summary\n          const minimalSummary = items.map(item => ({\n            id: item.id,\n            name: (item.name || item.caseName || '').substring(0, 50),\n            qty: item.quantity || 1,\n            price: item.price || item.basePrice || item.totalPrice,\n          }));\n          paymentIntentParams.metadata.items = JSON.stringify(minimalSummary).substring(0, 450);\n        } else {\n          paymentIntentParams.metadata.items = itemsJson;\n        }\n        \n        paymentIntentParams.metadata.item_count = items.length.toString();\n      }\n      \n      if (customerInfo) {\n        // Store customer info without large data\n        const customerSummary = {\n          email: customerInfo.email || '',\n          name: customerInfo.name || '',\n          surname: customerInfo.surname || '',\n          // Exclude address details from metadata (they're in shipping param)\n        };\n        const customerJson = JSON.stringify(customerSummary);\n        if (customerJson.length <= 450) {\n          paymentIntentParams.metadata.customerInfo = customerJson;\n        } else {\n          // Just store email and name if too large\n          paymentIntentParams.metadata.customer_email = (customerInfo.email || '').substring(0, 100);\n          paymentIntentParams.metadata.customer_name = ((customerInfo.name || '') + ' ' + (customerInfo.surname || '')).substring(0, 100);\n        }\n        \n        if (customerInfo.email) {\n          paymentIntentParams.receipt_email = customerInfo.email;\n        }\n      }\n      \n      paymentIntentParams.metadata.orderId = `order_${Date.now()}`;\n    }\n\n    // Add description\n    if (items && Array.isArray(items) && items.length > 0) {\n      paymentIntentParams.description = `Order for ${items.length} item(s)`;\n    }\n\n    // Add shipping address if provided\n    if (customerInfo?.address) {\n      paymentIntentParams.shipping = {\n        name: customerInfo.name || 'Customer',\n        address: {\n          line1: customerInfo.address.line1 || '',\n          line2: customerInfo.address.line2 || '',\n          city: customerInfo.address.city || '',\n          postal_code: customerInfo.address.postal_code || '',\n          country: customerInfo.address.country || 'GB',\n          state: customerInfo.address.state || '',\n        },\n      };\n    }\n\n    const paymentIntent = await stripe.paymentIntents.create(paymentIntentParams);\n\n    return sendResponse(200, {\n      clientSecret: paymentIntent.client_secret,\n    });\n  } catch (err) {\n    console.error('Error creating payment intent:', err);\n    \n    // Provide more helpful error messages\n    let errorMessage = err.message || 'Failed to create payment intent';\n    \n    // Check for common Stripe API key errors\n    if (err.message && err.message.includes('Invalid API Key')) {\n      errorMessage = \"Invalid Stripe API key. Please check your STRIPE_SECRET_KEY in environment variables. Make sure it starts with 'sk_test_' (test mode) or 'sk_live_' (live mode) and has no extra spaces or characters.\";\n    } else if (err.message && err.message.includes('No API key provided')) {\n      errorMessage = 'Stripe API key is missing. Please set STRIPE_SECRET_KEY in environment variables.';\n    } else if (err.message && err.message.includes('STRIPE_SECRET_KEY')) {\n      // Keep the validation error message as-is\n      errorMessage = err.message;\n    }\n    \n    return sendResponse(500, { error: errorMessage });\n  }\n}\n\n// Handle OPTIONS for CORS\nexport async function OPTIONS() {\n  return sendResponse(200, {});\n}\n"],"names":[],"mappings":"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"}}]
}