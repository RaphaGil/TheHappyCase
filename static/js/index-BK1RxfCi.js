var E=(s,t,r)=>new Promise((l,o)=>{var c=i=>{try{g(r.next(i))}catch(x){o(x)}},m=i=>{try{g(r.throw(i))}catch(x){o(x)}},g=i=>i.done?l(i.value):Promise.resolve(i.value).then(c,m);g((r=r.apply(s,t)).next())});import{e as S,r as f,j as e,u as O,F as b,a as P}from"./react-vendor-DEB5L_3o.js";import{l as y,n as A}from"./shared-utils-DkooxM7j.js";import{u as k,v as D,w as C}from"./fontawesome-vendor-BEuASCuQ.js";import"./vendor-DosGu80M.js";const R=(s,t,r)=>{const[l]=S(),[o,c]=f.useState(!1),[m,g]=f.useState(!1),i=l.get("session_id"),x=f.useRef(!1);return f.useEffect(()=>{s&&(t!=null&&t.email)&&r&&r.length>0&&!m&&!x.current&&(x.current=!0,E(void 0,null,function*(){var j,N,v;try{console.log("ðŸ’¾ Attempting to save order to Supabase..."),console.log("  - Payment Intent:",s==null?void 0:s.id),console.log("  - Customer Email:",t==null?void 0:t.email),console.log("  - Items:",(r==null?void 0:r.length)||0);const h=yield fetch(y("/api/save-order"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntent:s,customerInfo:t,items:r})});console.log("ðŸ“¤ Order save response status:",h.status);const p=yield h.text();let a;if(!p||p.trim()==="")console.error("âŒ Empty response from server"),a={success:!1,error:"Empty response from server",status:h.status};else try{a=JSON.parse(p),console.log("ðŸ“¥ Order save response:",a)}catch(d){console.error("âŒ Failed to parse JSON response:",d),console.error("   Response text:",p.substring(0,200)),a={success:!1,error:"Invalid JSON response from server",rawResponse:p.substring(0,200),status:h.status}}h.ok&&a.success||a.alreadyExists?(a.alreadyExists?console.log("âœ… Order already exists (idempotent):",a.order_id):console.log("âœ… Order saved to Supabase successfully:",a.order_id),g(!0)):(console.error("âŒ Failed to save order:",{status:h.status,success:a.success,error:a.error||a.message,details:a.details}),a.success&&((j=a.message)!=null&&j.includes("already exists")||a.warning)&&(console.log("âš ï¸ Duplicate order detected, marking as saved to prevent retries"),g(!0))),console.log("ðŸ“§ Attempting to send order confirmation email...");try{const d=yield fetch(y("/api/send-order-confirmation"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntent:s,customerInfo:t,items:r})});if(console.log("ðŸ“¤ Email response status:",d.status),d.ok){const n=yield d.json();console.log("ðŸ“¥ Email response:",n),n.success?(console.log("âœ… Order confirmation email sent successfully"),n.emailId&&console.log("   Email ID:",n.emailId)):(N=n.message)!=null&&N.includes("Resend API key not configured")||(v=n.warning)!=null&&v.includes("RESEND_API_KEY")?(console.warn("âš ï¸ Email not sent (configuration):",n.message||n.warning),console.warn("   This is expected if RESEND_API_KEY is not configured in .env"),console.warn("   Order was saved successfully, but email requires API key configuration")):(console.error("âŒ Failed to send email:",n.error||n.message),n.warning&&console.warn("   Warning:",n.warning))}else{const n=yield d.text();console.error("âŒ Email endpoint returned error:",d.status),console.error("   Error response:",n);try{const w=JSON.parse(n);console.error("   Parsed error:",w)}catch(w){}}}catch(d){console.error("âŒ Exception sending email:",d),console.error("   Error message:",d.message),console.error("   Error stack:",d.stack)}}catch(h){console.error("âŒ Error processing order:",h)}finally{x.current=!1}}))},[s,t,r,m]),f.useEffect(()=>{i&&!s&&(c(!0),fetch(y(`/session-status?session_id=${i}`)).then(u=>u.json()).then(u=>{u.status,c(!1)}).catch(u=>{console.error("Error fetching session:",u),c(!1)}))},[i,s]),{loading:o,orderSaved:m}},F=s=>s?new Date(s*1e3).toLocaleDateString("en-GB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",T=s=>!s||s.length===0?0:s.reduce((t,r)=>{const l=r.totalPrice||r.price||0,o=r.quantity||1;return t+l*o},0),_=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 font-inter",children:"Loading payment details..."})]})}),J=()=>{const s=O();return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center max-w-md mx-auto px-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-4",style:{fontFamily:"'Poppins', sans-serif"},children:"Invalid Access"}),e.jsx("p",{className:"text-gray-600 mb-6 font-inter",children:"This page can only be accessed after a successful payment."}),e.jsx("button",{onClick:()=>s("/"),className:"px-6 py-3 rounded-md bg-gray-900 hover:bg-gray-800 text-white transition-all duration-200 font-inter",children:"Go Home"})]})})},q=()=>e.jsxs("div",{className:"text-center mb-8 md:mb-12",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 md:w-24 md:h-24 rounded-full bg-green-100 mb-6",children:e.jsx(b,{icon:k,className:"text-green-600 text-4xl md:text-5xl"})}),e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-900 mb-3",style:{fontFamily:"'Poppins', sans-serif"},children:"Payment Successful!"}),e.jsx("p",{className:"text-base md:text-lg text-gray-600 max-w-2xl mx-auto font-inter",children:"Thank you for your order. We've received your payment and will process your items shortly."})]}),L=({item:s})=>{const t=s.designImage||s.caseImage||s.image,r=s.caseName||s.name||"Custom Case",l=(s.totalPrice||s.price||0)*(s.quantity||1);return e.jsx("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-100",children:e.jsxs("div",{className:"flex items-start gap-4",children:[t&&e.jsx("img",{src:A(t),alt:r,className:"w-16 h-16 md:w-20 md:h-20 object-contain rounded",loading:"lazy"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-900 mb-1 font-inter",children:r}),s.color&&e.jsxs("p",{className:"text-sm text-gray-600 mb-1 font-inter",children:["Color: ",e.jsx("span",{className:"font-medium",children:s.color})]}),s.pinsDetails&&s.pinsDetails.length>0&&e.jsxs("p",{className:"text-sm text-gray-600 mb-1 font-inter",children:["Charms: ",e.jsx("span",{className:"font-medium",children:s.pinsDetails.length})]}),s.quantity>1&&e.jsxs("p",{className:"text-sm text-gray-600 mb-1 font-inter",children:["Quantity: ",e.jsx("span",{className:"font-medium",children:s.quantity})]}),e.jsxs("p",{className:"text-sm font-semibold text-gray-900 mt-2 font-inter",children:["Â£",l.toFixed(2)]})]})]})})},z=({orderId:s,orderDate:t,totalAmount:r,orderStatus:l,items:o})=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6 md:p-8",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-semibold mb-6 text-gray-900",style:{fontFamily:"'Poppins', sans-serif"},children:"Order Details"}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Order ID:"}),e.jsx("span",{className:"text-gray-900 font-mono text-sm",children:s})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Date:"}),e.jsx("span",{className:"text-gray-900 font-inter",children:F(t)})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Amount:"}),e.jsxs("span",{className:"text-gray-900 font-semibold font-inter",children:["Â£",r.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"font-medium text-green-600 capitalize font-inter",children:"Status:"}),e.jsx("span",{className:"text-green-600 font-semibold capitalize font-inter",children:l})]})]}),o&&o.length>0&&e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900 font-inter",children:"Items Ordered:"}),e.jsx("div",{className:"space-y-3",children:o.map((c,m)=>e.jsx(L,{item:c},m))})]})]}),Y=({customerInfo:s})=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6 md:p-8",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-semibold mb-6 text-gray-900",style:{fontFamily:"'Poppins', sans-serif"},children:"Shipping Information"}),s&&s.name&&e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter block mb-1",children:"Name:"}),e.jsx("p",{className:"text-gray-900 font-inter",children:s.name})]}),s.email&&e.jsxs("div",{className:"py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter block mb-1",children:"Email:"}),e.jsx("p",{className:"text-gray-900 font-inter",children:s.email})]}),s.address&&s.address.line1&&e.jsxs("div",{className:"py-2",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter block mb-1",children:"Address:"}),e.jsxs("p",{className:"text-gray-900 font-inter",children:[s.address.line1,s.address.line2&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),s.address.line2]}),e.jsx("br",{}),s.address.city," ",s.address.postal_code,e.jsx("br",{}),s.address.country]})]})]}),e.jsxs("div",{className:"mt-6 p-4 md:p-5 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2 font-inter",children:"What's Next?"}),e.jsx("p",{className:"text-sm md:text-base text-blue-800 mb-3 font-inter",children:"Your order will be processed within 1-2 business days. You will receive a shipping confirmation email with tracking details once your items are dispatched."}),e.jsxs("p",{className:"text-sm md:text-base text-blue-800 font-inter",children:[e.jsx("strong",{children:"Estimated delivery:"})," 3-5 business days"]})]})]}),B=()=>{const s=O();return e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center mt-8 md:mt-12",children:[e.jsxs("button",{onClick:()=>s("/"),className:"px-6 py-3 rounded-md font-medium inline-flex items-center justify-center bg-gray-900 hover:bg-gray-800 text-white transition-all duration-200 font-inter",children:[e.jsx(b,{icon:D,className:"mr-2"}),"Continue Shopping"]}),e.jsxs("button",{onClick:()=>window.print(),className:"px-6 py-3 rounded-md font-medium inline-flex items-center justify-center bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 hover:border-gray-400 transition-all duration-200 font-inter",children:[e.jsx(b,{icon:C,className:"mr-2"}),"Print Receipt"]})]})},H=()=>e.jsx("div",{className:"mt-8 md:mt-12 text-center",children:e.jsxs("p",{className:"text-gray-600 font-inter",children:["Questions about your order? Contact us at"," ",e.jsx("a",{href:"mailto:support@thehappycase.com",className:"text-gray-900 hover:underline font-medium",children:"support@thehappycase.com"})]})}),$=()=>{const s=P(),[t]=S(),{paymentIntent:r,customerInfo:l,items:o}=s.state||{},c=t.get("session_id"),{loading:m}=R(r,l,o);if(m)return e.jsx(_,{});if(!r&&!c)return e.jsx(J,{});const g=T(o),i=(r==null?void 0:r.id)||c||"N/A",x=(r==null?void 0:r.created)||Date.now()/1e3,u=(r==null?void 0:r.status)||"succeeded";return e.jsx("div",{className:"min-h-screen bg-white py-8 md:py-12",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx(q,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8",children:[e.jsx(z,{orderId:i,orderDate:x,totalAmount:g,orderStatus:u,items:o}),e.jsx(Y,{customerInfo:l})]}),e.jsx(B,{}),e.jsx(H,{})]})})};export{$ as default};
