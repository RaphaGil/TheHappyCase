var T=(s,c,r)=>new Promise((n,d)=>{var u=t=>{try{x(r.next(t))}catch(y){d(y)}},h=t=>{try{x(r.throw(t))}catch(y){d(y)}},x=t=>t.done?n(t.value):Promise.resolve(t.value).then(u,h);x((r=r.apply(s,c)).next())});import{e as J,r as b,j as e,u as I,F as k,a as G}from"./react-vendor-oGZ_6Ua-.js";import{o as P}from"./shared-utils-BFPS16no.js";import{g as L}from"./index-jqra4qpZ.js";import{x as H,y as Y,g as B}from"./fontawesome-vendor-DeakGBTR.js";import{O as W}from"./OrderItem-kL4_ceQS.js";import"./vendor-Q-ueIuah.js";import"./supabase-vendor-rHdX91gy.js";const F="thehappycase_order_data",U=L(),q=(s,c,r)=>{const[n]=J(),[d,u]=b.useState(!1),[h,x]=b.useState(!1),[t,y]=b.useState(null),j=n.get("session_id"),p=b.useRef(!1),N=b.useRef({paymentIntent:s,customerInfo:c,items:r}),v=b.useRef(!1);return b.useEffect(()=>{if(s&&c&&r){N.current={paymentIntent:s,customerInfo:c,items:r};try{sessionStorage.setItem(F,JSON.stringify({paymentIntent:s,customerInfo:c,items:r,timestamp:Date.now()}))}catch(a){console.warn("âš ï¸ Could not save to sessionStorage:",a)}t&&y(null),v.current=!1}},[s,c,r,t]),b.useEffect(()=>{if((!s||!c||!r)&&j&&!t&&!v.current){v.current=!0;try{const a=sessionStorage.getItem(F);if(a){const o=JSON.parse(a);Date.now()-o.timestamp<36e5&&(console.log("ðŸ“¦ Recovering order data from sessionStorage"),y(o),N.current=o)}}catch(a){console.warn("âš ï¸ Could not recover from sessionStorage:",a)}}},[s,c,r,j,t]),b.useEffect(()=>{const a=s||(t==null?void 0:t.paymentIntent)||N.current.paymentIntent,o=c||(t==null?void 0:t.customerInfo)||N.current.customerInfo,g=r||(t==null?void 0:t.items)||N.current.items;a&&(o!=null&&o.email)&&g&&g.length>0&&!h&&!p.current&&(p.current=!0,T(void 0,null,function*(){var O,A,_,w;try{let f=null;const S=typeof window!="undefined"?localStorage.getItem("userId"):null;if(S)f=S,console.log("âœ… User ID retrieved from localStorage:",f);else if(U)try{const{data:l,error:i}=yield U.auth.getUser();!i&&((O=l==null?void 0:l.user)!=null&&O.id)?(f=l.user.id,localStorage.setItem("userId",f),console.log("âœ… User ID retrieved from Supabase auth:",f)):(console.log("â„¹ï¸ No authenticated user found, order will be saved without user_id"),i&&console.log("   Auth error:",i.message))}catch(l){console.warn("âš ï¸ Error getting user ID from Supabase:",l)}f||console.log("â„¹ï¸ No user ID available - order will be saved without user_id"),console.log("ðŸ’¾ Attempting to save order to Supabase..."),console.log("  - Payment Intent:",a==null?void 0:a.id),console.log("  - Customer Email:",o==null?void 0:o.email),console.log("  - User ID:",f||"N/A"),console.log("  - Items:",(g==null?void 0:g.length)||0);const E=yield fetch(P("/api/save-order"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntent:a,customerInfo:o,items:g,userId:f})});console.log("ðŸ“¤ Order save response status:",E.status);const R=yield E.text();let m;if(!R||R.trim()==="")console.error("âŒ Empty response from server"),m={success:!1,error:"Empty response from server",status:E.status};else try{m=JSON.parse(R),console.log("ðŸ“¥ Order save response:",m)}catch(l){console.error("âŒ Failed to parse JSON response:",l),console.error("   Response text:",R.substring(0,200)),m={success:!1,error:"Invalid JSON response from server",rawResponse:R.substring(0,200),status:E.status}}E.ok&&m.success||m.alreadyExists?(m.alreadyExists?console.log("âœ… Order already exists (idempotent):",m.order_id):console.log("âœ… Order saved to Supabase successfully:",m.order_id),x(!0)):(console.error("âŒ Failed to save order:",{status:E.status,success:m.success,error:m.error||m.message,details:m.details}),m.success&&((A=m.message)!=null&&A.includes("already exists")||m.warning)&&(console.log("âš ï¸ Duplicate order detected, marking as saved to prevent retries"),x(!0))),console.log("ðŸ“§ Attempting to send order confirmation email...");try{const l=yield fetch(P("/api/send-order-confirmation"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntent:a,customerInfo:o,items:g})});if(console.log("ðŸ“¤ Email response status:",l.status),l.ok){const i=yield l.json();console.log("ðŸ“¥ Email response:",i),i.success?(console.log("âœ… Order confirmation email sent successfully"),i.emailId&&console.log("   Email ID:",i.emailId)):(_=i.message)!=null&&_.includes("Resend API key not configured")||(w=i.warning)!=null&&w.includes("RESEND_API_KEY")?(console.warn("âš ï¸ Email not sent (configuration):",i.message||i.warning),console.warn("   This is expected if RESEND_API_KEY is not configured in .env"),console.warn("   Order was saved successfully, but email requires API key configuration")):(console.error("âŒ Failed to send email:",i.error||i.message),i.warning&&console.warn("   Warning:",i.warning))}else{const i=yield l.text();console.error("âŒ Email endpoint returned error:",l.status),console.error("   Error response:",i);try{const C=JSON.parse(i);console.error("   Parsed error:",C)}catch(C){}}}catch(l){console.error("âŒ Exception sending email:",l),console.error("   Error message:",l.message),console.error("   Error stack:",l.stack)}}catch(f){console.error("âŒ Error processing order:",f)}finally{p.current=!1}}))},[s,c,r,h,j,t]),b.useEffect(()=>{j&&!s&&!h&&!p.current?(u(!0),p.current=!0,fetch(P(`/session-status?session_id=${j}`)).then(a=>a.json()).then(a=>T(void 0,null,function*(){if(a.status==="complete"&&a.payment_intent){console.log("âœ… Session complete, payment_intent:",a.payment_intent);try{const o=yield fetch(P(`/api/orders?payment_intent_id=${a.payment_intent}`));if(o.ok){const g=yield o.json();if(g&&g.success&&g.order){console.log("âœ… Order already exists in Supabase:",g.order.order_id),x(!0),u(!1),p.current=!1;return}}}catch(o){console.warn("âš ï¸ Could not check existing order:",o)}if(a.customer_email){console.log("â„¹ï¸ Session complete but order not found in Supabase. Checking sessionStorage..."),p.current=!1,u(!1);return}u(!1)}else u(!1);p.current=!1})).catch(a=>{console.error("Error fetching session:",a),u(!1),p.current=!1})):j&&!s&&u(!1)},[j,s,h]),{loading:d,orderSaved:h}},K=s=>s?new Date(s*1e3).toLocaleDateString("en-GB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",V=s=>!s||s.length===0?0:s.reduce((c,r)=>{const n=r.totalPrice||r.price||0,d=r.quantity||1;return c+n*d},0),z=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 font-inter",children:"Loading payment details..."})]})}),$=()=>{const s=I();return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center max-w-md mx-auto px-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-4",style:{fontFamily:"'Poppins', sans-serif"},children:"Invalid Access"}),e.jsx("p",{className:"text-gray-600 mb-6 font-inter",children:"This page can only be accessed after a successful payment."}),e.jsx("button",{onClick:()=>s("/"),className:"px-6 py-3 rounded-md bg-gray-900 hover:bg-gray-800 text-white transition-all duration-200 font-inter",children:"Go Home"})]})})},Q=()=>e.jsxs("div",{className:"text-center mb-8 md:mb-12",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 md:w-24 md:h-24 rounded-full bg-green-100 mb-6",children:e.jsx(k,{icon:H,className:"text-green-600 text-4xl md:text-5xl"})}),e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-900 mb-3",style:{fontFamily:"'Poppins', sans-serif"},children:"Payment Successful!"}),e.jsx("p",{className:"text-base md:text-lg text-gray-600 max-w-2xl mx-auto font-inter",children:"Thank you for your order. We've received your payment and will process your items shortly."})]}),M=({orderId:s,orderDate:c,subtotal:r,shippingCost:n,vatAmount:d,totalAmount:u,orderStatus:h,items:x})=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6 md:p-8",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-semibold mb-6 text-gray-900",style:{fontFamily:"'Poppins', sans-serif"},children:"Order Details"}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Order ID:"}),e.jsx("span",{className:"text-gray-900 font-mono text-sm",children:s})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Date:"}),e.jsx("span",{className:"text-gray-900 font-inter",children:K(c)})]}),e.jsxs("div",{className:"pt-2 space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center py-1",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Subtotal:"}),e.jsxs("span",{className:"text-gray-900 font-inter",children:["Â£",r.toFixed(2)]})]}),n>0&&e.jsxs("div",{className:"flex justify-between items-center py-1",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"Shipping:"}),e.jsxs("span",{className:"text-gray-900 font-inter",children:["Â£",n.toFixed(2)]})]}),d>0&&e.jsxs("div",{className:"flex justify-between items-center py-1",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter",children:"VAT:"}),e.jsxs("span",{className:"text-gray-900 font-inter",children:["Â£",d.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-t border-gray-200 mt-2",children:[e.jsx("span",{className:"text-gray-900 font-semibold font-inter",children:"Total:"}),e.jsxs("span",{className:"text-gray-900 font-semibold text-lg font-inter",children:["Â£",u.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-t border-gray-200",children:[e.jsx("span",{className:"font-medium text-green-600 capitalize font-inter",children:"Status:"}),e.jsx("span",{className:"text-green-600 font-semibold capitalize font-inter",children:h})]})]}),x&&x.length>0&&e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900 font-inter",children:"Items Ordered:"}),e.jsx("div",{className:"space-y-3",children:x.map((t,y)=>e.jsx(W,{item:t},y))})]})]}),X=({customerInfo:s})=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm p-6 md:p-8",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-semibold mb-6 text-gray-900",style:{fontFamily:"'Poppins', sans-serif"},children:"Shipping Information"}),s&&s.name&&e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter block mb-1",children:"Name:"}),e.jsx("p",{className:"text-gray-900 font-inter",children:s.name})]}),s.email&&e.jsxs("div",{className:"py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter block mb-1",children:"Email:"}),e.jsx("p",{className:"text-gray-900 font-inter",children:s.email})]}),s.address&&s.address.line1&&e.jsxs("div",{className:"py-2",children:[e.jsx("span",{className:"text-gray-600 font-medium font-inter block mb-1",children:"Address:"}),e.jsxs("p",{className:"text-gray-900 font-inter",children:[s.address.line1,s.address.line2&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),s.address.line2]}),e.jsx("br",{}),s.address.city," ",s.address.postal_code,e.jsx("br",{}),s.address.country]})]})]}),e.jsxs("div",{className:"mt-6 p-4 md:p-5 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2 font-inter",children:"What's Next?"}),e.jsx("p",{className:"text-sm md:text-base text-blue-800 mb-3 font-inter",children:"Your order will be processed within 1-2 business days. You will receive a shipping confirmation email with tracking details once your items are dispatched."}),e.jsxs("p",{className:"text-sm md:text-base text-blue-800 font-inter",children:[e.jsx("strong",{children:"Estimated delivery:"})," 3-5 business days"]})]})]}),Z=()=>{const s=I();return e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center mt-8 md:mt-12",children:[e.jsxs("button",{onClick:()=>s("/"),className:"px-6 py-3 rounded-md font-medium inline-flex items-center justify-center bg-gray-900 hover:bg-gray-800 text-white transition-all duration-200 font-inter",children:[e.jsx(k,{icon:Y,className:"mr-2"}),"Continue Shopping"]}),e.jsxs("button",{onClick:()=>window.print(),className:"px-6 py-3 rounded-md font-medium inline-flex items-center justify-center bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 hover:border-gray-400 transition-all duration-200 font-inter",children:[e.jsx(k,{icon:B,className:"mr-2"}),"Print Receipt"]})]})},ee=()=>e.jsx("div",{className:"mt-8 md:mt-12 text-center",children:e.jsxs("p",{className:"text-gray-600 font-inter",children:["Questions about your order? Contact us at"," ",e.jsx("a",{href:"mailto:support@thehappycase.com",className:"text-gray-900 hover:underline font-medium",children:"support@thehappycase.com"})]})}),ce=()=>{var O,A,_;const s=G(),[c]=J(),{paymentIntent:r,customerInfo:n,items:d,shippingCost:u=0,vatAmount:h=0,totalWithShipping:x,subtotal:t}=s.state||{},y=c.get("session_id"),{loading:j}=q(r,n,d);if(b.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[s.pathname]),j)return e.jsx(z,{});if(!r&&!y)return e.jsx($,{});const p=t!==void 0?t:V(d);let N=u||0;if(!u&&((O=n==null?void 0:n.address)!=null&&O.country)&&(d==null?void 0:d.length)>0){const w={GB:3,US:16,FR:7},f=12,S=n.address.country.toUpperCase();N=(A=w[S])!=null?A:f}let v=h||0;if(!h&&((_=n==null?void 0:n.address)!=null&&_.country)){const w=new Set(["FR","DE","ES","IT"]),f=.2,S=n.address.country.toUpperCase();w.has(S)&&(v=p*f)}const a=x!==void 0?x:p+v+N,o=(r==null?void 0:r.id)||y||"N/A",g=(r==null?void 0:r.created)||Date.now()/1e3,D=(r==null?void 0:r.status)||"succeeded";return e.jsx("div",{className:"min-h-screen bg-white py-8 md:py-12",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx(Q,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8",children:[e.jsx(M,{orderId:o,orderDate:g,subtotal:p,shippingCost:N,vatAmount:v,totalAmount:a,orderStatus:D,items:d}),e.jsx(X,{customerInfo:n})]}),e.jsx(Z,{}),e.jsx(ee,{})]})})};export{ce as default};
