var w=(c,x,d)=>new Promise((i,v)=>{var p=n=>{try{f(d.next(n))}catch(u){v(u)}},j=n=>{try{f(d.throw(n))}catch(u){v(u)}},f=n=>n.done?i(n.value):Promise.resolve(n.value).then(p,j);f((d=d.apply(c,x)).next())});import{u as M,f as W,r as m,j as e}from"./react-vendor-LWyrAfI5.js";import{g as _}from"./index-klybK4ps.js";import{o as q}from"./shared-utils-BFPS16no.js";import{O as H}from"./OrderItem-27We5j_4.js";import"./vendor-yZw98PtW.js";import"./fontawesome-vendor-DeakGBTR.js";import"./supabase-vendor-CslTPUap.js";const b=_(),J=c=>{if(!c)return"N/A";let x;if(typeof c=="string")x=new Date(c);else if(typeof c=="number")x=new Date(c*1e3);else return"N/A";return x.toLocaleDateString("en-GB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})},te=()=>{const c=M(),[x]=W(),d=x.get("email")||"",[i,v]=m.useState(d),[p,j]=m.useState(""),[f,n]=m.useState(d?"code":"email"),[u,l]=m.useState(!1),[C,a]=m.useState(""),[A,h]=m.useState(!1),[I,S]=m.useState([]),[R,T]=m.useState(!1),[L,E]=m.useState(""),[N,P]=m.useState(!1);m.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"});const t=localStorage.getItem("userEmail"),s=localStorage.getItem("isLoggedIn")==="true";s&&t&&(P(!0),v(t),k(t)),d&&!s&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d)&&$(d)},[c,x,d]);const k=t=>w(void 0,null,function*(){T(!0),E("");try{if(!t)throw new Error("Email is required to fetch orders");const s=q(`/get-orders?email=${encodeURIComponent(t)}`);console.log("ðŸ“¡ Fetching orders by email:",t);const r=yield fetch(s);if((r.headers.get("content-type")||"").includes("text/html"))throw new Error("Backend server returned HTML (likely 404). Is the server running on port 3001?");const y=yield r.text();if(!y||y.trim()==="")throw new Error(`Server returned empty response (${r.status}). Check server logs for errors.`);let o;try{o=JSON.parse(y)}catch(O){throw new Error(`Server returned invalid JSON (${r.status}): ${O.message}`)}if(!r.ok){const O=(o==null?void 0:o.error)||(o==null?void 0:o.message)||`Server error: ${r.status} ${r.statusText}`;throw new Error(O)}o.success&&o.orders!==void 0?S(o.orders||[]):o.error?E(o.error||"Failed to load orders"):S(Array.isArray(o)?o:o.orders||[])}catch(s){console.error("Error fetching orders:",s),E(s.message||"Failed to load your orders. Please try again later.")}finally{T(!1)}}),$=t=>w(void 0,null,function*(){l(!0),a("");try{if(!b)throw new Error("Supabase is not configured. Please check your environment variables.");const{data:s,error:r}=yield b.auth.signInWithOtp({email:t,options:{emailRedirectTo:null}});if(r){console.error("âŒ Error sending OTP:",r),a(r.message||"Failed to send verification code. Please try again."),l(!1);return}console.log("âœ… OTP sent successfully:",s),l(!1),n("code"),h(!0),setTimeout(()=>h(!1),3e3)}catch(s){console.error("âŒ Exception sending OTP:",s),l(!1),a(s.message||"Failed to send verification code. Please try again.")}}),F=t=>w(void 0,null,function*(){if(t.preventDefault(),!i){a("Please enter your email address");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){a("Please enter a valid email address");return}l(!0),a(""),h(!1);try{if(!b)throw new Error("Supabase is not configured. Please check your environment variables.");const{data:r,error:g}=yield b.auth.signInWithOtp({email:i.trim(),options:{emailRedirectTo:null}});if(g){console.error("âŒ Error sending OTP:",g),a(g.message||"Failed to send verification code. Please try again."),l(!1);return}console.log("âœ… OTP sent successfully:",r),l(!1),n("code"),h(!0),setTimeout(()=>h(!1),3e3)}catch(r){console.error("âŒ Exception sending OTP:",r),l(!1),a(r.message||"Failed to send verification code. Please try again.")}}),D=t=>w(void 0,null,function*(){if(t.preventDefault(),!p||p.length!==6){a("Please enter the 6-digit code");return}l(!0),a(""),h(!1);try{if(!b)throw new Error("Supabase is not configured. Please check your environment variables.");const{data:s,error:r}=yield b.auth.verifyOtp({email:i.trim(),token:p.trim(),type:"email"});if(r){console.error("âŒ Error verifying OTP:",r),a(r.message||"Invalid code. Please try again."),l(!1);return}console.log("âœ… OTP verified successfully:",s);const{data:{user:g},error:y}=yield b.auth.getUser();if(y||!g){console.error("âŒ Error getting user:",y),a("Failed to get user information. Please try again."),l(!1);return}const o=g.email||i;localStorage.setItem("userEmail",o),localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userId",g.id),console.log("âœ… User logged in:",o),console.log("âœ… User ID:",g.id),P(!0),n("orders"),yield k(o)}catch(s){console.error("âŒ Exception verifying OTP:",s),a(s.message||"Invalid code. Please try again."),l(!1)}}),U=()=>{j(""),a(""),h(!1),F({preventDefault:()=>{}})},V=()=>{n("email"),j(""),a(""),h(!1),c("/login")},B=()=>{localStorage.removeItem("userEmail"),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId"),P(!1),S([]),n("email"),v(""),j("")};return e.jsx("div",{className:"min-h-screen bg-white py-12 md:py-16",children:e.jsxs("div",{className:`${N?"max-w-6xl":"max-w-md"} mx-auto px-4 sm:px-6 lg:px-8`,children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-title md:text-title-lg font-light text-gray-900 mb-2 font-inter tracking-title",children:N?"My Orders":f==="email"?"Log In":"Verify Code"}),e.jsx("div",{className:"w-16 h-px bg-gray-300 mx-auto mb-4"}),N&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-600 font-inter",children:i}),e.jsx("button",{onClick:B,className:"mt-2 text-sm text-gray-600 hover:text-gray-900 font-light font-inter underline",children:"Sign Out"})]})]}),A&&f==="code"&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-green-800 font-light font-inter",children:["Verification code sent to ",e.jsx("strong",{children:i})]})}),C&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800 font-light font-inter",children:C})}),f==="email"&&e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-2 font-light font-inter",children:"Email Address *"}),e.jsx("input",{type:"email",value:i,onChange:t=>{v(t.target.value),a("")},placeholder:"your.email@example.com",autoFocus:!0,className:"w-full px-4 py-3 border border-gray-200 rounded-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 placeholder-gray-400 font-light font-inter text-base",required:!0})]}),e.jsx("button",{type:"submit",disabled:u,className:"w-full px-4 py-3 text-sm uppercase tracking-wider font-light font-inter bg-gray-900 text-white hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u?"Sending Code...":"Send Verification Code"}),e.jsx("p",{className:"text-xs text-gray-500 text-center font-light font-inter",children:"By continuing, you agree to our Terms of Use and Privacy Policy."})]}),f==="code"&&e.jsxs("form",{onSubmit:D,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-600 font-light font-inter mb-4 text-center",children:["We've sent a 6-digit verification code to ",e.jsx("strong",{children:i}),". Please enter it below."]}),e.jsx("label",{className:"block text-sm text-gray-700 mb-2 font-light font-inter",children:"Verification Code *"}),e.jsx("input",{type:"text",value:p,onChange:t=>{const s=t.target.value.replace(/\D/g,"").slice(0,6);j(s),a("")},placeholder:"000000",maxLength:6,autoFocus:!0,className:"w-full px-4 py-3 border border-gray-200 rounded-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 placeholder-gray-400 font-light font-inter text-2xl text-center tracking-widest",required:!0})]}),e.jsx("button",{type:"submit",disabled:u||p.length!==6,className:"w-full px-4 py-3 text-sm uppercase tracking-wider font-light font-inter bg-gray-900 text-white hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u?"Verifying...":"Verify Code"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("button",{type:"button",onClick:U,disabled:u,className:"text-sm text-gray-600 hover:text-gray-900 font-light font-inter underline disabled:opacity-50",children:"Resend Code"}),e.jsx("button",{type:"button",onClick:V,className:"text-sm text-gray-600 hover:text-gray-900 font-light font-inter",children:"â† Back to email"})]})]}),N&&e.jsx("div",{className:"mt-8",children:R?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"}),e.jsx("p",{className:"mt-4 text-gray-600 font-inter",children:"Loading your orders..."})]}):L?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6 text-center",children:[e.jsx("p",{className:"text-sm text-red-800 font-light font-inter",children:L}),e.jsx("button",{onClick:()=>k(i),className:"mt-4 px-6 py-2 text-sm bg-gray-900 hover:bg-gray-800 text-white rounded-md transition-colors font-inter",children:"Try Again"})]}):I.length===0?e.jsxs("div",{className:"bg-gray-50 rounded-lg shadow-sm p-8 md:p-12 text-center",children:[e.jsx("div",{className:"text-gray-400 mb-4",children:e.jsx("svg",{className:"mx-auto h-16 w-16",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2 font-inter",children:"No Orders Yet"}),e.jsx("p",{className:"text-gray-600 mb-6 font-inter",children:"You haven't placed any orders yet. Start shopping to see your orders here!"}),e.jsx("button",{onClick:()=>c("/"),className:"px-6 py-3 bg-gray-900 hover:bg-gray-800 text-white rounded-md transition-colors font-inter",children:"Start Shopping"})]}):e.jsx("div",{className:"space-y-6",children:I.map(t=>{var s,r;return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-1 font-inter",children:["Order #",t.order_id.slice(-8).toUpperCase()]}),e.jsxs("p",{className:"text-sm text-gray-600 font-inter",children:["Placed on ",J(t.order_date)]})]}),e.jsxs("div",{className:"flex flex-col sm:items-end gap-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold font-inter ${t.status==="succeeded"||t.status==="complete"?"bg-green-100 text-green-800":t.status==="processing"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:((s=t.status)==null?void 0:s.charAt(0).toUpperCase())+((r=t.status)==null?void 0:r.slice(1))})}),e.jsxs("p",{className:"text-lg font-bold text-gray-900 font-inter",children:["Â£",parseFloat(t.total_amount).toFixed(2)]})]})]})}),e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"space-y-4",children:t.items&&Array.isArray(t.items)&&t.items.length>0?t.items.map((g,y)=>e.jsx(H,{item:g},y)):e.jsx("p",{className:"text-gray-600 font-inter",children:"No items found in this order."})})})]},t.order_id)})})})]})})};export{te as default};
